---
# AWS EC2 Dynamic Inventory Configuration
# This plugin automatically discovers EC2 instances based on tags and filters

plugin: aws_ec2

# AWS regions to search for instances
# Region will be set via AWS_REGION environment variable in GitHub Actions
regions:
  - us-west-2  # Default region, can be overridden

# Filter instances by tags
filters:
  tag:ManagedBy: Terraform
  instance-state-name: running

# How to construct inventory hostnames
hostnames:
  - tag:Name
  - private-ip-address

# Set connection variables for all hosts
compose:
  ansible_host: public_ip_address
  ansible_user: ubuntu  # Default user for Ubuntu-based instances
  ansible_ssh_private_key_file: ~/.ssh/id_rsa  # Path used in GitHub Actions
  ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

# Group instances by various attributes
keyed_groups:
  # Group by Environment tag (dev, prod, etc.)
  - key: tags.Environment
    prefix: env
    separator: _

  # Group by Project tag
  - key: tags.Project
    prefix: project
    separator: _

  # Group by Role tag (creates: role_guacamole, role_AttackBox, role_vpn_server)
  - key: tags.Role
    prefix: role
    separator: _

  # Group by instance type
  - key: instance_type
    prefix: instance_type
    separator: _

  # Group by availability zone
  - key: placement.availability_zone
    prefix: az
    separator: _

# Create friendly group names for backward compatibility
groups:
  # Guacamole servers group (flexible matching)
  guacamole: "'guacamole' in (tags.Name | lower) or tags.Role in ['guacamole', 'Guacamole']"
  
  # Also create role_guacamole for consistency
  role_guacamole: "'guacamole' in (tags.Name | lower) or tags.Role in ['guacamole', 'Guacamole']"
  
  # VPN servers group
  vpn_servers: "'vpn' in (tags.Name | lower) or tags.Role in ['vpn-server', 'vpn_server']"
  
  # AttackBox instances
  attackbox: "tags.Role == 'AttackBox'"

# Cache settings (improves performance)
cache: yes
cache_plugin: jsonfile
cache_timeout: 300
cache_connection: /tmp/ansible-aws-ec2-cache
cache_prefix: aws_ec2
