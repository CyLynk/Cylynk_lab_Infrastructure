define(["jquery", "core/ajax", "core/notification", "core/str"], function (
  $,
  Ajax,
  Notification,
  Str,
) {
  let config = {
    cmid: 0,
    templateId: "",
    sessionDuration: 2,
    sessionId: null,
    pollInterval: null,
    pollIntervalMs: 3000,
  };
  const elements = {
    startBtn: null,
    terminateBtn: null,
    lynkboxBtn: null,
    statusDiv: null,
    targetInfo: null,
    targetIp: null,
    copyIpBtn: null,
    progressDiv: null,
    progressBar: null,
    progressText: null,
  };
  const init = function (cmid, templateId, sessionDuration) {
    config.cmid = cmid;
    config.templateId = templateId;
    config.sessionDuration = sessionDuration;
    elements.startBtn = $("#cyberlab-start-btn");
    elements.terminateBtn = $("#cyberlab-terminate-btn");
    elements.lynkboxBtn = $("#cyberlab-lynkbox-btn");
    elements.statusDiv = $("#cyberlab-session-status");
    elements.targetInfo = $("#cyberlab-target-info");
    elements.targetIp = $("#cyberlab-target-ip");
    elements.copyIpBtn = $("#cyberlab-copy-ip");
    elements.progressDiv = $("#cyberlab-launch-progress");
    elements.progressBar = $("#cyberlab-progress-bar");
    elements.progressText = $("#cyberlab-progress-text");
    elements.startBtn.on("click", startLab);
    elements.terminateBtn.on("click", confirmTerminate);
    elements.lynkboxBtn.on("click", openLynkBox);
    elements.copyIpBtn.on("click", copyIpAddress);
    checkExistingSession();
  };
  const checkExistingSession = function () {
    Ajax.call([
      {
        methodname: "mod_cyberlab_get_active_session",
        args: { cmid: config.cmid },
      },
    ])[0]
      .done(function (response) {
        if (response.session_id) {
          config.sessionId = response.session_id;
          if (response.status === "running") {
            showRunningState(response.target_ip);
          } else if (response.status === "launching") {
            showLaunchingState();
            startPolling();
          }
        }
      })
      .fail(function () {});
  };
  const startLab = function () {
    elements.startBtn.prop("disabled", true);
    showLaunchingState();
    Ajax.call([
      {
        methodname: "mod_cyberlab_start_session",
        args: { cmid: config.cmid, template_id: config.templateId },
      },
    ])[0]
      .done(function (response) {
        if (response.success) {
          config.sessionId = response.session_id;
          startPolling();
        } else {
          showError(response.error || "Failed to start lab session.");
        }
      })
      .fail(function (error) {
        showError(error.message || "Failed to start lab session.");
      });
  };
  const confirmTerminate = function () {
    Str.get_string("confirmterminate", "mod_cyberlab").done(function (message) {
      Notification.confirm(
        Str.get_string("terminatelab", "mod_cyberlab"),
        message,
        Str.get_string("yes", "core"),
        Str.get_string("no", "core"),
        terminateLab,
      );
    });
  };
  const terminateLab = function () {
    if (!config.sessionId) {
      return;
    }
    elements.terminateBtn.prop("disabled", true);
    Ajax.call([
      {
        methodname: "mod_cyberlab_terminate_session",
        args: { cmid: config.cmid, session_id: config.sessionId },
      },
    ])[0]
      .done(function (response) {
        if (response.success) {
          stopPolling();
          config.sessionId = null;
          showIdleState();
          Str.get_string("sessionterminated", "mod_cyberlab").done(
            function (message) {
              Notification.addNotification({
                message: message,
                type: "success",
              });
            },
          );
        } else {
          showError(response.error || "Failed to terminate session.");
        }
      })
      .fail(function (error) {
        showError(error.message || "Failed to terminate session.");
      })
      .always(function () {
        elements.terminateBtn.prop("disabled", false);
      });
  };
  const openLynkBox = function () {
    if (typeof window.LaunchAttackBox !== "undefined") {
      window.LaunchAttackBox();
    } else {
      const launcher = document.querySelector(".attackbox-launcher");
      if (launcher) {
        launcher.click();
      } else {
        Notification.addNotification({
          message:
            "LynkBox launcher not available. Please ensure the AttackBox plugin is installed.",
          type: "warning",
        });
      }
    }
  };
  const copyIpAddress = function () {
    const ip = elements.targetIp.text();
    if (ip && ip !== "-") {
      navigator.clipboard
        .writeText(ip)
        .then(function () {
          Str.get_string("ipcopied", "mod_cyberlab").done(function (message) {
            Notification.addNotification({ message: message, type: "success" });
          });
        })
        .catch(function () {
          const textarea = document.createElement("textarea");
          textarea.value = ip;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        });
    }
  };
  const startPolling = function () {
    if (config.pollInterval) {
      return;
    }
    config.pollInterval = setInterval(pollStatus, config.pollIntervalMs);
    pollStatus();
  };
  const stopPolling = function () {
    if (config.pollInterval) {
      clearInterval(config.pollInterval);
      config.pollInterval = null;
    }
  };
  const pollStatus = function () {
    if (!config.sessionId) {
      stopPolling();
      return;
    }
    Ajax.call([
      {
        methodname: "mod_cyberlab_get_session_status",
        args: { cmid: config.cmid, session_id: config.sessionId },
      },
    ])[0]
      .done(function (response) {
        updateStatusDisplay(response);
        if (response.status === "running") {
          showRunningState(response.target_ip);
          stopPolling();
        } else if (
          response.status === "terminated" ||
          response.status === "error"
        ) {
          stopPolling();
          if (response.status === "error") {
            showError(
              response.error_message || "Lab session encountered an error.",
            );
          } else {
            showIdleState();
          }
          config.sessionId = null;
        } else if (response.status === "launching") {
          updateProgress(response.progress || 50);
        }
      })
      .fail(function () {});
  };
  const updateStatusDisplay = function (response) {
    const statusMap = {
      pending: "Initializing...",
      launching: "Launching lab VM...",
      running: "Lab is running",
      terminated: "Session ended",
      error: "Error",
    };
    const statusText = statusMap[response.status] || response.status;
    elements.progressText.text(statusText);
  };
  const updateProgress = function (percent) {
    elements.progressBar.css("width", percent + "%");
  };
  const showIdleState = function () {
    elements.startBtn.show().prop("disabled", false);
    elements.terminateBtn.hide();
    elements.lynkboxBtn.hide();
    elements.targetInfo.hide();
    elements.progressDiv.hide();
    Str.get_string("nosessionstarted", "mod_cyberlab").done(function (message) {
      elements.statusDiv.html('<p class="text-muted">' + message + "</p>");
    });
  };
  const showLaunchingState = function () {
    elements.startBtn.hide();
    elements.terminateBtn.show().prop("disabled", false);
    elements.lynkboxBtn.hide();
    elements.targetInfo.hide();
    elements.progressDiv.show();
    updateProgress(10);
    Str.get_string("launchinglab", "mod_cyberlab").done(function (message) {
      elements.progressText.text(message);
    });
  };
  const showRunningState = function (targetIp) {
    elements.startBtn.hide();
    elements.terminateBtn.show().prop("disabled", false);
    elements.lynkboxBtn.show();
    elements.targetInfo.show();
    elements.targetIp.text(targetIp || "-");
    elements.progressDiv.hide();
    Str.get_string("labready", "mod_cyberlab").done(function (message) {
      elements.statusDiv.html(
        '<p class="text-success font-weight-bold">' + message + "</p>",
      );
    });
  };
  const showError = function (message) {
    showIdleState();
    Notification.addNotification({ message: message, type: "error" });
  };
  return { init: init };
});
